#!/bin/bash

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
CONTAINER_NAME="monitoring_db"  # –∏–º—è —Ç–≤–æ–µ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å PostgreSQL
DB_NAME="monitoring_bot"                 # –∏–º—è —Ü–µ–ª–µ–≤–æ–π –ë–î
DB_USER="postgres"                       # –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë–î
DUMP_FILE="dump.sql"                     # –ø—É—Ç—å –∫ –¥–∞–º–ø—É

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª –¥–∞–º–ø–∞
if [ ! -f "$DUMP_FILE" ]; then
  echo "‚ùå –§–∞–π–ª –¥–∞–º–ø–∞ '$DUMP_FILE' –Ω–µ –Ω–∞–π–¥–µ–Ω!"
  exit 1
fi

echo "üîÑ –ù–∞—á–∏–Ω–∞–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–º–ø–∞ –≤ –ë–î '$DB_NAME' –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ '$CONTAINER_NAME'..."

# –®–∞–≥ 1: –û—á–∏—Å—Ç–∫–∞ –ë–î (—É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü, –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π, –∏–Ω–¥–µ–∫—Å–æ–≤ –∏ —Ç.–¥.)
echo "üßπ –û—á–∏—â–∞–µ–º —Ü–µ–ª–µ–≤—É—é –ë–î..."
docker exec -i "$CONTAINER_NAME" psql -U "$DB_USER" -d "$DB_NAME" <<EOF
DROP SCHEMA public CASCADE;
CREATE SCHEMA public;
EOF

if [ $? -ne 0 ]; then
  echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ë–î"
  exit 1
fi

# –®–∞–≥ 2: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–º–ø–∞
echo "üì• –í—ã–ø–æ–ª–Ω—è–µ–º –∏–º–ø–æ—Ä—Ç –¥–∞–º–ø–∞ –≤ –ë–î..."
docker exec -i "$CONTAINER_NAME" psql -U "$DB_USER" -d "$DB_NAME" < "$DUMP_FILE"

if [ $? -eq 0 ]; then
  echo "‚úÖ –î–∞–º–ø —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ –ë–î '$DB_NAME'"
else
  echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –¥–∞–º–ø–∞"
  exit 1
fi